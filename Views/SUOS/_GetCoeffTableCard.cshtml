@model SUOS

<div id="getCoeffTableCard" class="card">
    <div class="card-header ">
        <h5 class="card-category">List of users for service</h5>
        <h4 class="card-title">GetCoeff</h4>
        <p class="category">A ranking of the users with most requests to this service in the specified time period</p>
        <div class="dropdown">
            <button type="button" class="btn btn-round btn-outline-default dropdown-toggle btn-icon no-caret" data-toggle="dropdown">
                <i class="now-ui-icons loader_gear"></i>
            </button>
            <div class="dropdown-menu dropdown-menu-right text-right"> @* TODO: Extract service name as a constant *@
                <a class="dropdown-item" href="@Url.Action("GetUsersData", "SUOSApi", new { serviceName = Constants.SUOSGetCoeffServiceName })" target="_blank">Get JSON</a>

                <form id="getCsvZip" asp-action="GetServiceJsonZip" target="_blank">
                    <input class="dropdown-item" type="submit" value="Get Service JSON Zip" />
                </form>

                <form id="getLogsZip" asp-action="GetLogsZip" target="_blank">
                    <input class="dropdown-item" type="submit" value="Get Logs Zip" />
                </form>

                <a class="dropdown-item text-danger refresh" href="#">Refresh Data</a>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table id="getCoeffTable" class="table">
                <thead class="text-primary text-right">
                    <tr>
                        <th class="text-right" style="width: 5%">
                            view
                        </th>
                        <th class="text-center" style="width: 5%">
                            #
                        </th>
                        <th class="text-left" style="width: 40%">
                            User
                        </th>
                        @foreach (var server in Model.MonitoredServers)
                        {
                            <th class="text-right" style="width: 10%">
                                /@server/
                            </th>
                        }
                        <th class="text-right" style="width: 10%">
                            Total
                        </th>
                    </tr>
                </thead>
                <tbody class="text-right">
                    <tr id="getCoeffTableLoader">
                        <td colspan="6">
                            <div class="rect-spinner">
                                <div class="rect1 bg-primary"></div>
                                <div class="rect2 bg-primary"></div>
                                <div class="rect3 bg-primary"></div>
                                <div class="rect4 bg-primary "></div>
                                <div class="rect5 bg-primary"></div>
                                Loading
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer ">
        <hr>
        <div class="stats">
            <div class="dropup">
                <button type="button" class="btn btn-round btn-outline-default dropdown-toggle btn-icon no-caret" data-toggle="dropdown">
                    <i class="now-ui-icons travel_info"></i>
                </button>
                <span class="stats-info"></span>
                <div class="dropdown-menu dropdown-menu-left">
                </div>
            </div>
        </div>
        <div class="stats text-right">
            <a class="show-more" href="#">
                <i class="now-ui-icons loader_refresh"></i> Show 5 more
            </a>
        </div>
    </div>
</div>

<script>
    function constructGetCoeffTable() {

        var data = null;

        var table = $("#getCoeffTable");
        var card = $("#getCoeffTableCard");
        var loader = $("#getCoeffTableLoader");

        var actions = $("#getCoeffTableCard > div.card-header > div > button");

        function getSelectedLists() {
            var selectedCheckboxes = table.find('tbody input[type="checkbox"][id^="display_"]:checked');
            return selectedCheckboxes.toArray().map(x => x.id.replace("display_", ""));
        }

        function getTableData() {
            return data;
        }

        function fetchData() {

            loader.show();
            loader.nextAll().hide();
            actions.attr("disabled", "disabled");

            $.ajax({
                url: '@Url.Action("GetUsersData", "SUOSApi", new { serviceName = Constants.SUOSGetCoeffServiceName })',
                success: function (r) {
                    updateMeta(r.meta);
                    updateData(r.results);
                }
            });
        }

        function updateMeta(metaData) {

            card.find('.getCsvZip input[name="filePaths"]').remove();
            card.find('.getLogsZip input[name="filePaths"]').remove();
            card.find('.card-footer .stats .dropup .dropdown-menu a').remove();

            for (var i = 0; i < metaData.files.length; i++) {

                var file = metaData.files[i];

                card.find(".getCsvZip").append(`<input type="hidden" name="filePaths" value="${file}">`);
                card.find(".getLogsZip").append(`<input type="hidden" name="filePaths" value="${file}">`);

                card.find('.card-footer .stats .dropup .dropdown-menu').append(`<a class="dropdown-item" href="javascript:void(0)">${file}</a>`);
            }

            var statsInfo = card.find('.card-footer .stats-info');

            statsInfo.text(`Consolidation summary from ${metaData.files.length} files
                            in the period from ${moment(metaData.from).format('yyyy-MM-DD')}
                            to ${moment(metaData.to).format('yyyy-MM-DD')}.`);

            card.find('.card-footer .stats.text-right').append(
                $('<b>').text(`Total of ${metaData.records} records.`).addClass("pull-left")
            );
        }

        function updateData(tableData) {

            if (!tableData) {
                fetchData();
                return;
            }

            loader.hide();
            loader.nextAll().remove();
            actions.removeAttr("disabled");

            if (tableData.length === 0) {
                showErrorNotification("No summary data was found for the time period and the selected monitored servers.");
                return;
            }

            var totalData = [];

            function getRecordByName(records, recordName) {
                for (var i = 0; i < records.length; i++) {
                    if (records[i].user === recordName) {
                        return records[i];
                    }
                }

                return null;
            }

            for (let i = 0; i < tableData.length; i++) {

                var tableDataRecords = tableData[i].records;
                for (var j = 0; j < tableDataRecords.length; j++) {

                    let current = tableDataRecords[j];
                    let existing = getRecordByName(totalData, current.user);

                    if (existing == null) {

                        totalData.push({
                            user: current.user,
                            count: current.count
                        });

                    } else {
                        existing.count += current.count;
                    }
                }
            }

            var tableBody = table.children('tbody');
            for (let i = 0; i < totalData.length; i++) {

                let current = totalData[i];

                var rowCounts = [];

                for (let j = 0; j < tableData.length; j++) {

                    let existing = getRecordByName(tableData[j].records, current.user);

                    if (existing == null) {
                        rowCounts.push(0);
                        continue;
                    }

                    rowCounts.push(existing.count);
                }

                rowCounts.push(current.count);

                // regular row template
                // TODO: Minify this by hand
                tableBody.append(`<tr class="${ i < 10 ? "" : "d-none"}">
                            <td class="text-center">
                                    <div class="form-check">
                                        <label class="form-check-label">
                                            <input id="display_${current.user}" class="form-check-input" type="checkbox">
                                            <span class="form-check-sign"></span>
                                        </label>
                                    </div>
                                </td>
                            <td>${i + 1}</td>                            
                            <td class="text-left">${current.user}</td>                            
                            <td>${rowCounts.join('</td><td>')}</td>                            
                    </tr>`);

            }

            if (data == null) {
                table.trigger('constructed.table.now-ui', [tableData]);
            } else {
                table.trigger('updated.table.now-ui', [tableData]);
            }

            data = tableData;
        }

        // EVENTS ->

        table.on('click',
            "thead a.sortable",
            function(e) {
                e.preventDefault();

                if (!data) {
                    return;
                }

                var anchor = $(e.target);
                var descendingOrder = anchor.hasClass("desc");
                var propertyName = anchor.attr("id").replace("sort_by_", "");

                $("#getCoeffTable thead a.sortable i").remove();
                $("#getCoeffTable thead a.sortable").removeClass("asc");
                $("#getCoeffTable thead a.sortable").removeClass("desc");

                if (!descendingOrder) {
                    anchor.addClass("desc");
                    anchor.append(`<i class="now-ui-icons arrows-1_minimal-down"></i>`);

                    data.sort(function(a, b) {
                        return b[propertyName] - a[propertyName];
                    });

                } else {
                    anchor.addClass("asc");
                    anchor.append(`<i class="now-ui-icons arrows-1_minimal-up"></i>`);

                    data.sort(function(a, b) {
                        return a[propertyName] - b[propertyName];
                    });
                }

                updateData(data);

                table.trigger('updated.table.now-ui', [data]);
            });

        table.on('click',
            'input[type="checkbox"][id^=display_]',
            function(e) {

                var checkbox = $(e.target);
                var selected = checkbox.is(":checked");
                var listName = checkbox.attr("id").replace("display_", "");
                var row = checkbox.closest("tr");
                var index = row.index();

                table.trigger('updated.table.now-ui', [data]);
            });

        card.on('click',
            "a.refresh",
            function(e) {
                e.preventDefault();
                updateData();
            });

        card.on('click',
            "a.show-more",
            function(e) {
                e.preventDefault();

                var hiddenElements = card.find("tr.d-none");
                if (hiddenElements.length) {
                    hiddenElements.slice(0, 5).removeClass("d-none");
                }
            });

        return {

            card: card,
            table: table,
            loaderRow: loader,
            actionsButton: actions,

            getSelectedLists: getSelectedLists,
            getTableData: getTableData,
            updateData: updateData
        };
    }

</script>