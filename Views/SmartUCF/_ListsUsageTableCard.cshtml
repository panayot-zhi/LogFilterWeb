<div id="listsUsageTableCard" class="card">
    <div class="card-header ">
        <h5 class="card-category">General Analysis</h5>
        <h4 class="card-title">Lists usage table data</h4>
        <p class="category">A breakdown of all lists by significance in the monitored period</p>
        <div class="dropdown">
            <button type="button" class="btn btn-round btn-outline-default dropdown-toggle btn-icon no-caret" data-toggle="dropdown">
                <i class="now-ui-icons loader_gear"></i>
            </button>
            <div class="dropdown-menu dropdown-menu-right text-right">
                <a class="dropdown-item" href="@Url.Action("GetStopwatchListsData")" target="_blank">Get JSON</a>

                <form id="getCsvZip" asp-action="GetCsvZip" target="_blank">
                    <input class="dropdown-item" type="submit" value="Get Csv Zip" />
                </form>

                <form id="getLogsZip" asp-action="GetLogsZip" target="_blank">
                    <input class="dropdown-item" type="submit" value="Get Logs Zip" />
                </form>

                <a id="refreshListsUsageTable" class="dropdown-item text-danger" href="#">Refresh Data</a>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table id="listsUsageTable" class="table">
                <thead class="text-primary text-right">
                    <tr>
                        <th class="text-right" style="width: 5%">
                            view
                        </th>
                        <th class="text-center" style="width: 5%">
                            #
                        </th>
                        <th class="text-left" style="width: 40%">
                            listName
                        </th>
                        <th class="text-right" style="width: 10%">
                            <a id="sort_by_totalRowsRetrieved" class="sortable desc" href="#">
                                total Rows Retrieved<i class="now-ui-icons arrows-1_minimal-down"></i>
                            </a>
                        </th>
                        <th class="text-right" style="width: 10%">
                            <a id="sort_by_totalRecords" class="sortable" href="#">
                                total<br>Records
                            </a>
                        </th>
                        <th style="width: 10%">
                            <a id="sort_by_avgRowsRetrieved" class="sortable" href="#">
                                avg<br>Rows Retrieved
                            </a>
                        </th>
                        <th style="width: 10%">
                            <a id="sort_by_avgRetrieveTime" class="sortable" href="#">
                                avg<br>Retrieve Time (ms)
                            </a>
                        </th>
                        <th style="width: 10%">
                            <a id="sort_by_maxRetrieveTime" class="sortable" href="#">
                                max<br>Retrieve Time (ms)
                            </a>
                        </th>
                    </tr>
                </thead>
                <tbody class="text-right">
                    <tr id="listsUsageTableLoader">
                        <td colspan="8">
                            <div class="rect-spinner">
                                <div class="rect1 bg-primary"></div>
                                <div class="rect2 bg-primary"></div>
                                <div class="rect3 bg-primary"></div>
                                <div class="rect4 bg-primary "></div>
                                <div class="rect5 bg-primary"></div>
                                Loading
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer ">
        <hr>
        <div class="stats">
            <div class="dropup">
                <button type="button" class="btn btn-round btn-outline-default dropdown-toggle btn-icon no-caret" data-toggle="dropdown">
                    <i class="now-ui-icons travel_info"></i>
                </button>
                <span class="stats-info"></span>
                <div class="dropdown-menu dropdown-menu-left">
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function constructListsUsageTable() {

        var data = null;        

        var table = $("#listsUsageTable");
        var card = $("#listsUsageTableCard");
        var loader = $("#listsUsageTableLoader");

        var actions = $("#listsUsageTableCard > div.card-header > div > button");

        function getSelectedLists() {
            var selectedCheckboxes = table.find('tbody input[type="checkbox"][id^="display_"]:checked');
            return selectedCheckboxes.toArray().map(x => x.id.replace("display_", ""));
        }

        function getTableData() {
            return data;
        }

        function fetchData() {

            loader.show();
            loader.nextAll().hide();
            actions.attr("disabled", "disabled");

            $.ajax({
                url: '@Url.Action("GetStopwatchListsData")',
                success: function (r) {
                    updateMeta(r.meta);
                    updateData(r.results);
                }
            });
        }

        function updateMeta(metaData) {            

            $('#getCsvZip input[name="filePaths"]').remove();
            $('#getLogsZip input[name="filePaths"]').remove();
            $('#listsUsageTableCard .card-footer .stats .dropup .dropdown-menu a').remove();

            for (var i = 0; i < metaData.files.length; i++) {

                var file = metaData.files[i];

                $("#getCsvZip").append(`<input type="hidden" name="filePaths" value="${file}">`);
                $("#getLogsZip").append(`<input type="hidden" name="filePaths" value="${file}">`);

                $('#listsUsageTableCard .card-footer .stats .dropup .dropdown-menu').append(`<a class="dropdown-item" href="javascript:void(0)">${file}</a>`);
            }
            
            $('#listsUsageTableCard .card-footer .stats-info').text(`
                            Consolidation summary from ${metaData.files.length} files
                            in the period from ${moment(metaData.from).format('yyyy-MM-DD')}
                            to ${moment(metaData.to).format('yyyy-MM-DD')}.`);
        }

        function updateData(tableData) {

            if (!tableData) {
                fetchData();
                return;
            }

            loader.hide();
            loader.nextAll().remove();
            actions.removeAttr("disabled");

            var tableBody = table.children('tbody');
            for (var i = 0; i < tableData.length; i++) {
                var listData = tableData[i];

                // add a display property to the data
                listData.display = i >= 5 ? false: true;

                // regular row template
                // TODO: Minify this by hand
                tableBody.append(`<tr style="background-color: ${listData.display ? availableColors[i] : ""}">
                                <td class="text-center">
                                    <div class="form-check">
                                        <label class="form-check-label">
                                            <input id="display_${listData.id}" class="form-check-input" type="checkbox" ${listData.display ? "checked" : ""}>
                                            <span class="form-check-sign"></span>
                                        </label>
                                    </div>
                                </td>
                                <td class="text-center">
                                    ${i + 1}
                                </td>
                                <td class="text-left">
                                    ${listData.listName}
                                </td>
                                <td>
                                    ${parseFloat(listData.totalRowsRetrieved).toLocaleString('bg')}
                                </td>
                                <td>
                                    ${parseFloat(listData.totalRecords).toLocaleString('bg')}
                                </td>
                                <td>
                                    ${Math.round(listData.avgRowsRetrieved)}
                                </td>
                                <td>
                                    ${parseFloat(listData.avgRetrieveTime).toFixed(2)}
                                </td>
                                <td>
                                    ${listData.maxRetrieveTime}
                                </td>
                            </tr>`);
            }

            var sumRowsRetrieved = tableData.reduce((x, { totalRowsRetrieved }) => x + totalRowsRetrieved, 0);
            var sumRecords = tableData.reduce((x, { totalRecords }) => x + totalRecords, 0);
            var avgAllRows = Math.round(sumRowsRetrieved / sumRecords);

            // total row template
            // TODO: Minify this by hand
            tableBody.append(`<tr class="font-weight-bold">
                                <td>

                                </td>
                                <td>

                                </td>
                                <td class="text-left">
                                   <b>Total / Average:</b>
                                </td>
                                <td>
                                    ${parseFloat(sumRowsRetrieved).toLocaleString('bg')}
                                </td>
                                <td>
                                    ${parseFloat(sumRecords).toLocaleString('bg')}
                                </td>
                                <td>
                                    ${Math.round(avgAllRows)}
                                </td>
                                <td>

                                </td>
                                <td>

                                </td>
                            </tr>`);

            if (data == null) {                
                table.trigger('constructed.table.now-ui', [tableData]);
            } else {                
                table.trigger('updated.table.now-ui', [tableData]);
            }            

            data = tableData;
        }

        // EVENTS ->

        table.on('click',
            "thead a.sortable",
            function(e) {
                e.preventDefault();

                if (!data) {
                    return;
                }

                var anchor = $(e.target);
                var descendingOrder = anchor.hasClass("desc");
                var propertyName = anchor.attr("id").replace("sort_by_", "");

                $("#listsUsageTable thead a.sortable i").remove();
                $("#listsUsageTable thead a.sortable").removeClass("asc");
                $("#listsUsageTable thead a.sortable").removeClass("desc");

                if (!descendingOrder) {
                    anchor.addClass("desc");
                    anchor.append(`<i class="now-ui-icons arrows-1_minimal-down"></i>`);

                    data.sort(function(a, b) {
                        return b[propertyName] - a[propertyName];
                    });

                } else {
                    anchor.addClass("asc");
                    anchor.append(`<i class="now-ui-icons arrows-1_minimal-up"></i>`);

                    data.sort(function(a, b) {
                        return a[propertyName] - b[propertyName];
                    });
                }

                updateData(data);

                table.trigger('updated.table.now-ui', [data]);
            });

        table.on('click',
            'input[type="checkbox"][id^=display_]',
            function(e) {                

                var checkbox = $(e.target);
                var selected = checkbox.is(":checked");
                var listName = checkbox.attr("id").replace("display_", "")
                var row = checkbox.closest("tr");
                var index = row.index();                

                var dataElement = data.find(x => x.id === listName);                

                if (selected) {
                    dataElement.display = true;
                    row.attr("style", "background-color: " + availableColors[index - 1]);
                } else {
                    row.removeAttr("style");
                    dataElement.display = false;
                }

                table.trigger('updated.table.now-ui', [data]);
            });

        card.on('click',
            "#refreshListsUsageTable",
            function(e) {
                e.preventDefault();
                updateData();
            });

        return {            

            card: card,
            table: table,
            loaderRow: loader,
            actionsButton: actions,

            getSelectedLists: getSelectedLists,
            getTableData: getTableData,
            updateData: updateData
        };
    }

</script>