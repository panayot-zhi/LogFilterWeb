@model SmartUCF

@{
    ViewData["Title"] = "SmartUCF";
}

@section head {
    <!-- Chart JS -->
    <script src="~/lib/Chart.js/Chart.min.js"></script>
}

@section sidebar {
    <li class="active">
        <a href="@Url.Action("Index", "Home")">
            <i class="now-ui-icons arrows-1_minimal-left"></i>
            <p>SmartUCF</p>
        </a>
    </li>

    <li class="active-pro">
        <a href="~/swagger" target="_blank">
            <i class="now-ui-icons files_paper"></i>
            <p>Swagger</p>
        </a>
    </li>
}

@section navbar {

    <div class="navbar-wrapper">
        <div class="navbar-toggle">
            <button type="button" class="navbar-toggler">
                <span class="navbar-toggler-bar bar1"></span>
                <span class="navbar-toggler-bar bar2"></span>
                <span class="navbar-toggler-bar bar3"></span>
            </button>
        </div>
        <a id="headerChartTitle" class="navbar-brand" href="#">Dashboard</a>
    </div>

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-bar navbar-kebab"></span>
        <span class="navbar-toggler-bar navbar-kebab"></span>
        <span class="navbar-toggler-bar navbar-kebab"></span>
    </button>

    <div class="collapse navbar-collapse justify-content-end" id="navigation">

        <form>
            <div class="input-group no-border">
                <input type="text" name="daterange" class="form-control" />
                <div class="input-group-append">
                    <div class="input-group-text">
                        <i class="now-ui-icons ui-1_calendar-60"></i>
                    </div>
                </div>
            </div>
        </form>

        <ul class="navbar-nav">

            <li class="nav-item">
                <a class="nav-link" href="#" onclick="window.location.reload(true)">
                    <i class="now-ui-icons arrows-1_refresh-69"></i>
                    <p>
                        <span class="d-lg-none d-md-block">Refresh</span>
                    </p>
                </a>
            </li>
            
            <li id="headerChartOptions" class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" id="headerChartOptionsLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="now-ui-icons media-2_sound-wave"></i>
                    <p>
                        <span class="d-lg-none d-md-block">Chart Options</span>
                    </p>
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="headerChartOptionsLink">
                    <h6 class="dropdown-header">Display property</h6>
                    <a class="dropdown-item" id="display_property_totalRowsRetrieved" href="#">totalRowsRetrieved</a>
                    <a class="dropdown-item" id="display_property_totalRecords" href="#">totalRecords</a>
                    <a class="dropdown-item" id="display_property_avgRowsRetrieved" href="#">avgRowsRetrieved</a>
                    <a class="dropdown-item" id="display_property_avgRetrieveTime" href="#">avgRetrieveTime</a>
                    <a class="dropdown-item" id="display_property_maxRetrieveTime" href="#">maxRetrieveTime</a>
                    <a class="dropdown-item" id="display_property_maxRowsRetrieved" href="#">maxRowsRetrieved</a>
                    <h6 class="dropdown-header">Other</h6>
                    <a class="dropdown-item" id="headerChartRefresh" href="#">refresh</a>
                </div>
            </li>

            <li id="monitoredServersList" class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" id="monitoredServersListLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="now-ui-icons ui-2_settings-90"></i>
                    <p>
                        <span class="d-lg-none d-md-block">Monitored Servers</span>
                    </p>
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="monitoredServersListLink">

                    <h6 class="dropdown-header"><a id="display_old_servers" href="#">Old servers</a></h6>

                    @foreach (var server in Constants.SmartUCFOldMachines)
                    {
                        if (Model.MonitoredServers.Contains(server))
                        {
                            <a class="dropdown-item active" id="display_server_@server" href="#">@($"Server {server}")</a>
                        }
                        else
                        {
                            <a class="dropdown-item" id="display_server_@server" href="#">@($"Server {server}")</a>
                        }
                    }

                    <h6 class="dropdown-header"><a id="display_new_servers" href="#">New Servers</a></h6>

                    @foreach (var server in Constants.SmartUCFNewMachines)
                    {
                        if (Model.MonitoredServers.Contains(server))
                        {
                            <a class="dropdown-item active" id="display_server_@server" href="#">@($"Server {server}")</a>
                        }
                        else
                        {
                            <a class="dropdown-item" id="display_server_@server" href="#">@($"Server {server}")</a>
                        }
                    }
                </div>
            </li>

            <li class="nav-item">
                <a class="nav-link" href="#">
                    <i class="now-ui-icons users_single-02"></i>
                    <p>
                        <span class="d-lg-none d-md-block">User</span>
                    </p>
                </a>
            </li>

        </ul>
    </div>

}

@if (Model.SingleDate)
{
    <div class="panel-header">
        <div class="header text-center">
            <h2 class="title">Server data by Day</h2>
            <p class="category">You have selected a single date for a monitor period.<br>A historical graphic will not be constructed.</p>
        </div>
    </div>
}
else
{
    @*<div class="panel-header panel-header-lg">
            <div id="serverDailyUsageHeaderChartLoader">
                <div class="hrc-spinner text-white">
                    <div class="bounce1 bg-white"></div>
                    <div class="bounce2 bg-white"></div>
                    <div class="bounce3 bg-white"></div>
                    Loading
                </div>
            </div>
            <canvas id="serverDailyUsageHeaderChart"></canvas>
        </div>*@

    @await Html.PartialAsync("_ServersDailyHeaderChart")
}

<div class="content">
    <div class="row">
        <div class="col-md-7">
            
            @await Html.PartialAsync("_ListsUsageTableCard")

        </div>

        <div class="col-lg-5">
            <div id="listsUsagePieChartCard" class="card card-chart">
                <div class="card-header">
                    <h5 class="card-category">General Analysis</h5>
                    <h4 class="card-title">Percentage of all lists usage</h4>
                    <p class="category">Displays the percent that the chosen lists represent in comparison to other lists for the <b>total retrieved rows</b> in the monitored period.</p>
                    @*
                        <div class="dropdown">
                            <button type="button" class="btn btn-round btn-outline-default dropdown-toggle btn-icon no-caret" data-toggle="dropdown">
                                <i class="now-ui-icons loader_gear"></i>
                            </button>
                            <div class="dropdown-menu dropdown-menu-right">
                                <a class="dropdown-item" href="@Url.Action("GetStopwatchListData")" target="_blank">Get JSON</a>
                                <a class="dropdown-item" href="#">Get Stopwatch ZIP</a>
                                <a class="dropdown-item text-danger" href="#">Remove Data</a>
                            </div>
                        </div>
                    *@
                </div>
                <div class="card-body">
                    <div id="listsUsagePieChartLoader">
                        <div class="pulse-spinner bg-primary"></div>
                    </div>
                    <div class="chart-area" style="height: auto;">
                        <canvas id="listsUsagePieChart"></canvas>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="stats">
                        <i class="now-ui-icons travel_info"></i> <span class="stats-info">IMPLEMENT ME</span>
                    </div>
                </div>
            </div>

            <div id="serversUsagePieChartCard" class="card card-chart">
                <div class="card-header">
                    <h5 class="card-category">General Analysis</h5>
                    <h4 class="card-title">Servers usage proportion</h4>
                    <p class="category">A proportion of the servers utilization of how many <b>total rows they have retrieved</b> given the chosen lists and the monitored period</p>
                    @*<div class="dropdown">
                            <button type="button" class="btn btn-round btn-outline-default dropdown-toggle btn-icon no-caret" data-toggle="dropdown">
                                <i class="now-ui-icons loader_gear"></i>
                            </button>
                            <div class="dropdown-menu dropdown-menu-right">
                                <a class="dropdown-item" href="@Url.Action("GetStopwatchListData")" target="_blank">Get JSON</a>
                                <a class="dropdown-item" href="#" target="_blank">Get Csv Zip </a>
                                <a class="dropdown-item" href="#" target="_blank">Get Logs Zip</a>
                                <a class="dropdown-item text-danger" href="#">Remove Data</a>
                            </div>
                        </div>*@
                </div>
                <div class="card-body">
                    <div id="serversUsagePieChartLoader">
                        <div class="db-spinner">
                            <div class="double-bounce1 bg-primary"></div>
                            <div class="double-bounce2 bg-primary"></div>
                        </div>
                    </div>
                    <div class="chart-area" style="height: auto;">
                        <canvas id="serversUsagePieChart"></canvas>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="stats">
                        <i class="now-ui-icons travel_info"></i> <span class="stats-info"></span>
                    </div>
                </div>
            </div>

        </div>

    </div>
</div>

@section footer {
    @* no-op *@
}

@section scripts {
    <script>
        const smartUCFCookieName = "@SmartUCF.CookieName";
        const smartUCFServers = @Json.Serialize(Constants.SmartUCFMachines);

        function initializeDateRangePicker(initialStartDate, initialEndDate) {

            $('input[name="daterange"]').daterangepicker({
                    "startDate": initialStartDate,
                    "endDate": initialEndDate,
                    "opens": "center",
                    "locale": {
                        "format": "DD.MM.YYYY",
                        "firstDay": 1
                    }
                },
                function(newStartDate, newEndDate) {

                    //console.log("A new date selection was made: " + start.format('DD.MM.YYYY') + ' to ' + end.format('DD.MM.YYYY'));

                    var jsonCookieData = {};
                    var cookieData = Cookies.get(smartUCFCookieName);

                    if (cookieData) {
                        jsonCookieData = JSON.parse(cookieData);
                    }

                    jsonCookieData.startDate = newStartDate.toDate();
                    jsonCookieData.endDate = newEndDate.toDate();

                    Cookies.set(smartUCFCookieName, JSON.stringify(jsonCookieData));

                    window.location.reload(true);

                });
        }

        function initializeCurrentServersPicker() {
            $('#monitoredServersList').on('click',
                "#display_old_servers",
                function(e) {
                    e.preventDefault();

                    var serverNames = @Json.Serialize(Constants.SmartUCFOldMachines);

                    var jsonCookieData = {};
                    var cookieData = Cookies.get(smartUCFCookieName);

                    if (cookieData) {
                        jsonCookieData = JSON.parse(cookieData);
                    }

                    if (!jsonCookieData.monitoredServers) {
                        jsonCookieData.monitoredServers = [];
                    }

                    jsonCookieData.monitoredServers = serverNames;

                    Cookies.set(smartUCFCookieName, JSON.stringify(jsonCookieData));

                    window.location.reload(true);
                });

            $('#monitoredServersList').on('click',
                "#display_new_servers",
                function(e) {
                    e.preventDefault();

                    var serverNames = @Json.Serialize(Constants.SmartUCFNewMachines);

                    var jsonCookieData = {};
                    var cookieData = Cookies.get(smartUCFCookieName);

                    if (cookieData) {
                        jsonCookieData = JSON.parse(cookieData);
                    }

                    if (!jsonCookieData.monitoredServers) {
                        jsonCookieData.monitoredServers = [];
                    }

                    jsonCookieData.monitoredServers = serverNames;

                    Cookies.set(smartUCFCookieName, JSON.stringify(jsonCookieData));

                    window.location.reload(true);
                });

            $('#monitoredServersList').on('click',
                ".dropdown-item",
                function(e) {
                    e.preventDefault();

                    var serverName = this.id.replace("display_server_", "");

                    var jsonCookieData = {};
                    var cookieData = Cookies.get(smartUCFCookieName);

                    if (cookieData) {
                        jsonCookieData = JSON.parse(cookieData);
                    }

                    if (!jsonCookieData.monitoredServers) {
                        jsonCookieData.monitoredServers = [];
                    }

                    var active = $(this).hasClass('active');
                    if (active) {
                        var index = jsonCookieData.monitoredServers.indexOf(serverName);
                        if (index > -1) {
                            jsonCookieData.monitoredServers.splice(index, 1);
                        }
                    } else {
                        jsonCookieData.monitoredServers.push(serverName);
                    }

                    Cookies.set(smartUCFCookieName, JSON.stringify(jsonCookieData));

                    window.location.reload(true);
                });
        }

/*        function getSelectedListsFromTable() {
            var selectedCheckboxes = $('#listsUsageTable tbody input[type="checkbox"][id^="display_"]:checked');
            return selectedCheckboxes.toArray().map(x => x.id.replace("display_", ""));
        }*/

/*
        function updateListsUsageTable(data) {

            function updateInfo(info) {
                $('#getCsvZip input[name="filePaths"]').remove();
                $('#getLogsZip input[name="filePaths"]').remove();
                $('#listsUsageTableCard .card-footer .stats .dropup .dropdown-menu a').remove();

                for (var i = 0; i < info.files.length; i++) {

                    var file = info.files[i];

                    $("#getCsvZip").append(`<input type="hidden" name="filePaths" value="${file}">`);
                    $("#getLogsZip").append(`<input type="hidden" name="filePaths" value="${file}">`);

                    $('#listsUsageTableCard .card-footer .stats .dropup .dropdown-menu').append(`<a class="dropdown-item" href="javascript:void(0)">${file}</a>`);
                }

                $('#listsUsageTableCard .card-footer .stats-info').text(`
                            Consolidation summary from ${info.files.length} files
                            in the period from ${moment(info.from).format('yyyy-MM-DD')}
                            to ${moment(info.to).format('yyyy-MM-DD')}.`);
            }

            var table = $(`#listsUsageTable`);
            var tableBody = table.children('tbody');
            var loaderRow = table.find("#listsUsageTableLoader");

            if (!data) {

                loaderRow.show();
                loaderRow.nextAll().hide();

                $("#listsUsageTableCard > div.card-header > div > button").attr("disabled", "disabled");

                $.ajax({
                    url: 'Url.Action("GetStopwatchListsData")',
                    success: function(r) {
                        //console.log(r);
                        updateListsUsageTable(r.results);
                        updateInfo(r.meta);
                    }
                });

                return;
            }

            var checked = true;
            var initial = true;

            if (loaderRow.nextAll().length) {
                initial = false;
            }

            loaderRow.hide();
            loaderRow.nextAll().remove();

            $("#listsUsageTableCard > div.card-header > div > button").removeAttr("disabled");

            for (var i = 0; i < data.length; i++) {
                var listData = data[i];

                if (i >= 5) {
                    checked = false;
                }

                // regular row template
                tableBody.append(`<tr style="background-color: ${checked ? availableColors[i] : ""}">
                                <td class="text-center">
                                    <div class="form-check">
                                        <label class="form-check-label">
                                            <input id="display_${listData.id}" class="form-check-input" type="checkbox" ${checked ? "checked" : ""}>
                                            <span class="form-check-sign"></span>
                                        </label>
                                    </div>
                                </td>
                                <td class="text-center">
                                    ${i + 1}
                                </td>
                                <td class="text-left">
                                    ${listData.listName}
                                </td>
                                <td>
                                    ${parseFloat(listData.totalRowsRetrieved).toLocaleString('bg')}
                                </td>
                                <td>
                                    ${parseFloat(listData.totalRecords).toLocaleString('bg')}
                                </td>
                                <td>
                                    ${Math.round(listData.avgRowsRetrieved)}
                                </td>
                                <td>
                                    ${parseFloat(listData.avgRetrieveTime).toFixed(2)}
                                </td>
                                <td>
                                    ${listData.maxRetrieveTime}
                                </td>
                            </tr>`);
            }

            var sumRowsRetrieved = data.reduce((x, { totalRowsRetrieved }) => x + totalRowsRetrieved, 0);
            var sumRecords = data.reduce((x, { totalRecords }) => x + totalRecords, 0);
            var avgAllRows = Math.round(sumRowsRetrieved / sumRecords);

            // total row template
            tableBody.append(`<tr class="font-weight-bold">
                                <td>

                                </td>
                                <td>

                                </td>
                                <td class="text-left">
                                   <b>Total / Average:</b>
                                </td>
                                <td>
                                    ${parseFloat(sumRowsRetrieved).toLocaleString('bg')}
                                </td>
                                <td>
                                    ${parseFloat(sumRecords).toLocaleString('bg')}
                                </td>
                                <td>
                                    ${Math.round(avgAllRows)}
                                </td>
                                <td>

                                </td>
                                <td>

                                </td>
                            </tr>`);

            if (initial) {
                table.trigger('constructed.table.now-ui', [data]);
            } else {
                table.trigger('updated.table.now-ui', [data]);
            }
        }
*/

        function updateListsPieChart(data, pieChart) {

            function formatData(raw) {

                var labels = ["NotIncluded"];
                var colors = [namedColors.grey];
                var datasets = [0];


                for (var i = 0; i < raw.length; i++) {
                    var current = raw[i];

                    if (current.display) {
                        labels.push(current.listName);
                        datasets.push(current.totalRowsRetrieved);
                        colors.push(availableColors[i]);
                        continue;
                    }

                    datasets[0] += current.totalRowsRetrieved;
                }

                return {
                    datasets: [
                        {
                            data: datasets,
                            backgroundColor: colors
                        }
                    ],

                    labels: labels
                }
            }

            if (!data) {
                throw Error("No data! Pie chart cannot initialize.");
            }

            if (pieChart) {
                pieChart.data = formatData(data);
                pieChart.update();
                return null;
            }

            var pieChartLoader = $("#listsUsagePieChartLoader");
            var ctx = document.getElementById("listsUsagePieChart").getContext("2d");
            //var fill = drawGreenCanvasBackground(ctx);

            pieChartLoader.hide();

            return new Chart(ctx,
                {
                    type: 'pie',
                    data: formatData(data),

                    options: {
                        tooltips: {
                            enabled: true,
                            callbacks: {
                                label: function(tooltipItem, data) {
                                    //console.log(tooltipItem, data);
                                    const label = data.labels[tooltipItem.index];
                                    const val = data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
                                    const total = data.datasets[tooltipItem.datasetIndex].data.reduce((x, y) => x + y, 0);

                                    return '\t' + label + ' : ' + parseFloat(val / total * 100.0).toFixed(4) + "%";
                                }

                            }
                        }
                    },

                    plugins: [
                        {
                            beforeInit: function(chart) {
                                chart.legend.afterFit = function() {
                                    this.height = this.height + 30;
                                };
                            }
                        }
                    ]
                });
        }

        function updateServersPieChart(data, pieChart) {

            function formatData(raw) {

                var labels = [];
                var colors = [];

                if (raw.length) {
                    for (var j = 0; j < raw[0].servers.length; j++) {
                        var serverName = raw[0].servers[j].name;
                        labels.push(`Сървър S${serverName}`);
                        colors.push(availableColors[smartUCFServers.indexOf(serverName)]);
                    }
                }

                var datasets = [];

                for (var i = 0; i < raw.length; i++) {
                    var current = raw[i];

                    if (!current.display) {
                        continue;
                    }

                    var dataset = {
                        data: current.servers.map(x => x.retrieved),
                        backgroundColor: colors
                    };

                    datasets.push(dataset);

                }

                return {
                    datasets: datasets,
                    labels: labels
                }
            }

            function updateInfo(info) {

                var totalRowsDisplayed = 0;
                var datasets = info.datasets;
                for (var i = 0; i < datasets.length; i++) {
                    totalRowsDisplayed += datasets[i].data.reduce((a, b) => a + b);
                }

                $("#serversUsagePieChartCard .card-footer .stats-info").text(`Displaying data from ${info.datasets.length} lists. Total of ${nFormatter(totalRowsDisplayed, 2)} rows.`);
            }

            if (!data) {
                throw Error("No data! Pie chart cannot initialize.");
            }

            if (pieChart) {
                var newData = formatData(data);
                updateInfo(newData);
                pieChart.data = newData;
                pieChart.update();
                return null;
            }

            var pieChartLoader = $("#serversUsagePieChartLoader");
            var ctx = document.getElementById("serversUsagePieChart").getContext("2d");
            //var fill = drawGreenCanvasBackground(ctx);

            pieChartLoader.hide();

            var initialData = formatData(data);
            updateInfo(initialData);

            return new Chart(ctx,
                {
                    type: 'pie',
                    data: initialData,

                    options: {
                        tooltips: {
                            enabled: true,
                            callbacks: {
                                label: function(tooltipItem, data) {
                                    //console.log(tooltipItem, data);
                                    const label = data.labels[tooltipItem.index];
                                    const val = data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];

                                    return '\t' + label + ' : ' + parseInt(val).toLocaleString('bg');
                                }

                            }
                        }
                    },

                    plugins: [
                        {
                            beforeInit: function(chart) {
                                chart.legend.afterFit = function() {
                                    this.height = this.height + 30;
                                };
                            }
                        }
                    ]
                });
        }

        //var serverHeaderChart;
       /* function updateServersHeaderChart(data, displayProperty) {

            var headerChart = $("#serverDailyUsageHeaderChart");
            var headerChartLoader = $("#serverDailyUsageHeaderChartLoader");
            var ctx = document.getElementById("serverDailyUsageHeaderChart").getContext("2d");
            var fill = drawBlueCanvasBackground(ctx);
            
            if (!displayProperty) {
                displayProperty = "totalRowsRetrieved";
            }

            function formatData(raw) {
                console.log(raw);

                if (!raw.length) {
                    console.warn("No data!");
                    return null;
                }

                var labels = raw[0].records.map(x => moment(x.date).format('MMM DD'));
                var colors = raw.map((x) => availableColors[smartUCFServers.indexOf(x.name)]);
                var datasets = [];

                for (var i = 0; i < raw.length; i++) {

                    var server = raw[i];
                    
                    datasets.push({
                        label: "Server S" + server.name,
                        borderColor: colors[i],
                        pointBorderColor: namedColors.white,
                        pointBackgroundColor: colors[i],
                        pointHoverBackgroundColor: colors[i],
                        pointHoverBorderColor: namedColors.white,
                        pointBorderWidth: 1,
                        pointHoverRadius: 7,
                        pointHoverBorderWidth: 2,
                        pointRadius: 5,
                        fill: true,
                        backgroundColor: fill,
                        borderWidth: 2,
                        data: server.records.map((x) => x[displayProperty])
                    });
                }

                return {
                    labels: labels,
                    datasets: datasets
                }
            }

            function updateInfo(info) {
                //console.log(info);
                // TODO: Update navbar-brand with the current list display
                // TODO: Update navbar options with datasets
            }

            if (!data) {

                // TODO: A mechanism to skip retrieval if the list is the same

                // retrieve
                headerChart.hide();
                headerChartLoader.show();

                var selectedLists = getSelectedListsFromTable();
                if (!selectedLists.length) {
                    return null;
                }

                //var listName = selectedLists[0];

                $.ajax({
                    url: 'Url.Action("GetStopwatchServerDataByDay")?listName=' + listsUsageTable.getSelectedLists()[0], // TODO: remove this!
                    success: function(r) {
                        updateServersHeaderChart(r.results, displayProperty);
                        updateInfo(r.meta);
                    }
                });

                return;
            }

            headerChart.show();
            headerChartLoader.hide();

            $("#headerChartOptions a[id^=display_property_]").removeClass('active');
            $(`#display_property_${displayProperty}`).addClass('active');

            // update
            if (serverHeaderChart) {
                var newData = formatData(data);
                serverHeaderChart.data = newData;
                serverHeaderChart.update();
                return;
            }

            // initialize
            var initialData = formatData(data);
            serverHeaderChart = new Chart(ctx,
                {
                    type: 'line',
                    data: initialData,

                    options: {
                        layout: {
                            padding: {
                                left: 20,
                                right: 60,
                                top: 0,
                                bottom: 0
                            }
                        },
                        maintainAspectRatio: false,
                        tooltips: {
                            backgroundColor: '#fff',
                            titleFontColor: '#333',
                            bodyFontColor: '#666',
                            bodySpacing: 4,
                            xPadding: 12,
                            mode: "nearest",
                            intersect: 0,
                            position: "nearest",
                            enabled: true,
                            callbacks: {
                                label: function(tooltipItem, data) {
                                    var label = data.datasets[tooltipItem.datasetIndex].label;
                                    var val = data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];

                                    return '\t' + label + ' : ' + parseFloat(val).toLocaleString('bg');
                                }
                            }
                        },
                        legend: {
                            labels: {
                                fontColor: '#fff'
                            },
                            position: "bottom",
                            fillStyle: "#FFF",
                            display: true
                        },
                        scales: {
                            yAxes: [
                                {
                                    ticks: {
                                        fontColor: "rgba(255,255,255,0.4)",
                                        fontStyle: "bold",
                                        beginAtZero: true,
                                        maxTicksLimit: 5,
                                        padding: 10,
                                        callback: function(value, index, values) {
                                            return nFormatter(value);
                                        }
                                    },
                                    gridLines: {
                                        drawTicks: true,
                                        drawBorder: false,
                                        display: true,
                                        color: "rgba(255,255,255,0.1)",
                                        zeroLineColor: "transparent"
                                    }

                                }
                            ],
                            xAxes: [
                                {
                                    gridLines: {
                                        zeroLineColor: "transparent",
                                        display: false

                                    },
                                    ticks: {
                                        padding: 10,
                                        fontColor: "rgba(255,255,255,0.4)",
                                        fontStyle: "bold"
                                    }
                                }
                            ]
                        }
                    }
                });

        }*/
        
        $(document).ready(function() {
            const modelStartDate = "@Model.StartDate.ToString("dd.MM.yyyy")";
            const modelEndDate = "@Model.EndDate.ToString("dd.MM.yyyy")";
            initializeDateRangePicker(modelStartDate, modelEndDate);
            initializeCurrentServersPicker();
            //updateListsUsageTable();

            var listsPieChart;
            var serversPieChart;
            var serversDailyHeaderChart = window.constructServersDailyUsageHeaderChart();
            var listsUsageTable = window.constructListsUsageTable();

            listsUsageTable.table.on("constructed.table.now-ui",
                function (e, data) {
                    listsPieChart = updateListsPieChart(data);
                    serversPieChart = updateServersPieChart(data);

                    var currentList = listsUsageTable.getSelectedLists()[0];
                    serversDailyHeaderChart.updateData(currentList);                    
                });

            listsUsageTable.table.on("updated.table.now-ui",
                function(e, data) {
                    updateListsPieChart(data, listsPieChart);
                    updateServersPieChart(data, serversPieChart);

                    var currentList = listsUsageTable.getSelectedLists()[0];
                    serversDailyHeaderChart.updateData(currentList);
                });

            listsUsageTable.updateData();

            /*listUsageTable.on('click',
                'input[type="checkbox"][id^=display_]',
                function(e) {

                    var checkbox = $(e.target);
                    var selected = checkbox.is(":checked");
                    var row = checkbox.closest("tr");
                    var index = row.index();

                    if (selected) {
                        row.attr("style", "background-color: " + availableColors[index - 1]);
                    } else {
                        row.removeAttr("style");
                    }

                    listUsageTable.trigger('updated.table.now-ui', [e.target, e.target.checked, index]);
                });*/

            /*listUsageTable.on('click',
                "thead a.sortable",
                function(e) {
                    e.preventDefault();

                    if (!tableData) {
                        return;
                    }

                    var anchor = $(e.target);
                    var descendingOrder = anchor.hasClass("desc");
                    var propertyName = anchor.attr("id").replace("sort_by_", "");

                    $("#listsUsageTable thead a.sortable i").remove();
                    $("#listsUsageTable thead a.sortable").removeClass("asc");
                    $("#listsUsageTable thead a.sortable").removeClass("desc");

                    if (!descendingOrder) {
                        anchor.addClass("desc");
                        anchor.append(`<i class="now-ui-icons arrows-1_minimal-down"></i>`);
                        tableData.sort(function(a, b) {
                            return b[propertyName] - a[propertyName];
                        });
                    } else {
                        anchor.addClass("asc");
                        anchor.append(`<i class="now-ui-icons arrows-1_minimal-up"></i>`);
                        tableData.sort(function(a, b) {
                            return a[propertyName] - b[propertyName];
                        });
                    }

                    updateListsUsageTable(tableData);
                    listUsageTable.trigger('updated.table.now-ui', [e.target, descendingOrder]);
                });*/
            /*
            $("#headerChartOptions a.dropdown-item").on('click',
                function(e) {
                    e.preventDefault();
                    
                    //var displayProperty = this.id.replace("display_property_", "");
                    //updateServersHeaderChart(null, displayProperty);

                });

            $("#headerChartRefresh").on('click',
                function(e) {
                    e.preventDefault();

                    serverHeaderChart = null;
                    updateServersHeaderChart();
                });*/
/*

            $("#refreshListsUsageTable").on('click',
                function(e) {
                    e.preventDefault();
                    updateListsUsageTable();
                });*/
        });
    </script>
}
