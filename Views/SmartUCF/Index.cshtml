@model SmartUCF

@{
    ViewData["Title"] = "SmartUCF";
}

@section head {
    <!-- Chart JS -->
    <script src="~/lib/Chart.js/Chart.min.js"></script>
}

@section sidebar {
    <li class="active">
        <a href="@Url.Action("Index", "Home")">
            <i class="now-ui-icons arrows-1_minimal-left"></i>
            <p>SmartUCF</p>
        </a>
    </li>

    <li class="active-pro">
        <a href="~/swagger" target="_blank">
            <i class="now-ui-icons files_paper"></i>
            <p>Swagger</p>
        </a>
    </li>
}

@section navbar {

    <div class="navbar-wrapper">
        <div class="navbar-toggle">
            <button type="button" class="navbar-toggler">
                <span class="navbar-toggler-bar bar1"></span>
                <span class="navbar-toggler-bar bar2"></span>
                <span class="navbar-toggler-bar bar3"></span>
            </button>
        </div>
        <a id="headerChartTitle" class="navbar-brand" href="javascript: void(0);">Dashboard</a>
    </div>

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-bar navbar-kebab"></span>
        <span class="navbar-toggler-bar navbar-kebab"></span>
        <span class="navbar-toggler-bar navbar-kebab"></span>
    </button>

    <div class="collapse navbar-collapse justify-content-end" id="navigation">

        <form>
            <div class="input-group no-border">
                <input type="text" name="daterange" class="form-control" />
                <div class="input-group-append">
                    <div class="input-group-text">
                        <i class="now-ui-icons ui-1_calendar-60"></i>
                    </div>
                </div>
            </div>
        </form>

        <ul class="navbar-nav">

            <li class="nav-item">
                <a class="nav-link" href="#" onclick="window.location.reload(true)">
                    <i class="now-ui-icons arrows-1_refresh-69"></i>
                    <p>
                        <span class="d-lg-none d-md-block">Refresh</span>
                    </p>
                </a>
            </li>

            <li id="headerChartOptions" class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" id="headerChartOptionsLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="now-ui-icons media-2_sound-wave"></i>
                    <p>
                        <span class="d-lg-none d-md-block">Chart Options</span>
                    </p>
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="headerChartOptionsLink">
                    <h6 class="dropdown-header">Display property</h6>
                    <a class="dropdown-item" data-display="totalRowsRetrieved" href="#">totalRowsRetrieved</a>
                    <a class="dropdown-item" data-display="totalRecords" href="#">totalRecords</a>
                    <a class="dropdown-item" data-display="avgRowsRetrieved" href="#">avgRowsRetrieved</a>
                    <a class="dropdown-item" data-display="avgRetrieveTime" href="#">avgRetrieveTime</a>
                    <a class="dropdown-item" data-display="maxRetrieveTime" href="#">maxRetrieveTime</a>
                    <a class="dropdown-item" data-display="maxRowsRetrieved" href="#">maxRowsRetrieved</a>
                    <h6 class="dropdown-header">Other</h6>
                    <a class="dropdown-item refresh" href="#">refresh</a>
                </div>
            </li>

            <li id="monitoredServersList" class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" id="monitoredServersListLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="now-ui-icons ui-2_settings-90"></i>
                    <p>
                        <span class="d-lg-none d-md-block">Monitored Servers</span>
                    </p>
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="monitoredServersListLink">

                    <h6 class="dropdown-header"><a id="display_old_servers" href="#">Old servers</a></h6>

                    @foreach (var server in Constants.SmartUCFOldMachines)
                    {
                        if (Model.MonitoredServers.Contains(server))
                        {
                            <a class="dropdown-item active" id="display_server_@server" href="#">@($"Server {server}")</a>
                        }
                        else
                        {
                            <a class="dropdown-item" id="display_server_@server" href="#">@($"Server {server}")</a>
                        }
                    }

                    <h6 class="dropdown-header"><a id="display_new_servers" href="#">New Servers</a></h6>

                    @foreach (var server in Constants.SmartUCFNewMachines)
                    {
                        if (Model.MonitoredServers.Contains(server))
                        {
                            <a class="dropdown-item active" id="display_server_@server" href="#">@($"Server {server}")</a>
                        }
                        else
                        {
                            <a class="dropdown-item" id="display_server_@server" href="#">@($"Server {server}")</a>
                        }
                    }
                </div>
            </li>

            <li class="nav-item">
                <a class="nav-link" href="#">
                    <i class="now-ui-icons users_single-02"></i>
                    <p>
                        <span class="d-lg-none d-md-block">User</span>
                    </p>
                </a>
            </li>

        </ul>
    </div>

}

@await Html.PartialAsync("_ServersDailyHeaderChart")

<div class="content">
    <div class="row">
        <div class="col-md-7">

            @await Html.PartialAsync("_ListsUsageTableCard")

        </div>

        <div class="col-lg-5">

            @await Html.PartialAsync("_ListsUsagePieChartCard")
            @await Html.PartialAsync("_ServersUsagePieChartCard")

            @await Html.PartialAsync("_UsersUsageBarChartCard")
        </div>

    </div>
</div>

@section footer {
    @* no-op *@
}

@section scripts {
    <script>
        const smartUCFCookieName = "@SmartUCF.CookieName";
        const smartUCFServers = @Json.Serialize(Constants.SmartUCFMachines);

        function initializeDateRangePicker(initialStartDate, initialEndDate) {

            $('input[name="daterange"]').daterangepicker({
                    "startDate": initialStartDate,
                    "endDate": initialEndDate,
                    "opens": "center",
                    "locale": {
                        "format": "DD.MM.YYYY",
                        "firstDay": 1
                    }
                },
                function(newStartDate, newEndDate) {

                    //console.log("A new date selection was made: " + start.format('DD.MM.YYYY') + ' to ' + end.format('DD.MM.YYYY'));

                    var jsonCookieData = {};
                    var cookieData = Cookies.get(smartUCFCookieName);

                    if (cookieData) {
                        jsonCookieData = JSON.parse(cookieData);
                    }

                    jsonCookieData.startDate = newStartDate.toDate();
                    jsonCookieData.endDate = newEndDate.toDate();

                    Cookies.set(smartUCFCookieName, JSON.stringify(jsonCookieData));

                    window.location.reload(true);

                });
        }

        function initializeCurrentServersPicker() {
            $('#monitoredServersList').on('click',
                "#display_old_servers",
                function(e) {
                    e.preventDefault();

                    var serverNames = @Json.Serialize(Constants.SmartUCFOldMachines);

                    var jsonCookieData = {};
                    var cookieData = Cookies.get(smartUCFCookieName);

                    if (cookieData) {
                        jsonCookieData = JSON.parse(cookieData);
                    }

                    if (!jsonCookieData.monitoredServers) {
                        jsonCookieData.monitoredServers = [];
                    }

                    jsonCookieData.monitoredServers = serverNames;

                    Cookies.set(smartUCFCookieName, JSON.stringify(jsonCookieData));

                    window.location.reload(true);
                });

            $('#monitoredServersList').on('click',
                "#display_new_servers",
                function(e) {
                    e.preventDefault();

                    var serverNames = @Json.Serialize(Constants.SmartUCFNewMachines);

                    var jsonCookieData = {};
                    var cookieData = Cookies.get(smartUCFCookieName);

                    if (cookieData) {
                        jsonCookieData = JSON.parse(cookieData);
                    }

                    if (!jsonCookieData.monitoredServers) {
                        jsonCookieData.monitoredServers = [];
                    }

                    jsonCookieData.monitoredServers = serverNames;

                    Cookies.set(smartUCFCookieName, JSON.stringify(jsonCookieData));

                    window.location.reload(true);
                });

            $('#monitoredServersList').on('click',
                ".dropdown-item",
                function(e) {
                    e.preventDefault();

                    var serverName = this.id.replace("display_server_", "");

                    var jsonCookieData = {};
                    var cookieData = Cookies.get(smartUCFCookieName);

                    if (cookieData) {
                        jsonCookieData = JSON.parse(cookieData);
                    }

                    if (!jsonCookieData.monitoredServers) {
                        jsonCookieData.monitoredServers = [];
                    }

                    var active = $(this).hasClass('active');
                    if (active) {
                        var index = jsonCookieData.monitoredServers.indexOf(serverName);
                        if (index > -1) {
                            jsonCookieData.monitoredServers.splice(index, 1);
                        }
                    } else {
                        jsonCookieData.monitoredServers.push(serverName);
                    }

                    Cookies.set(smartUCFCookieName, JSON.stringify(jsonCookieData));

                    window.location.reload(true);
                });
        }

        $(document).ready(function() {
            const modelStartDate = "@Model.StartDate.ToString("dd.MM.yyyy")";
            const modelEndDate = "@Model.EndDate.ToString("dd.MM.yyyy")";
            initializeDateRangePicker(modelStartDate, modelEndDate);
            initializeCurrentServersPicker();

            var listsPieChart = window.constructListsUsagePieChartCard();
            var serversPieChart = window.constructServersUsagePieChartCard();
            var usersUsageBarChartCard = window.constructUsersUsageBarChartCard();
            var serversDailyHeaderChart = window.constructServersDailyUsageHeaderChart();
            var listsUsageTable = window.constructListsUsageTable();

            listsUsageTable.table.on("constructed.table.now-ui",
                function (e, data) {
                    listsPieChart.updateData(data);
                    serversPieChart.updateData(data);

                    var currentList = listsUsageTable.getSelectedLists()[0];
                    serversDailyHeaderChart.updateData(currentList);
                    usersUsageBarChartCard.updateData(currentList);
                });

            listsUsageTable.table.on("updated.table.now-ui",
                function(e, data) {
                    listsPieChart.updateData(data);
                    serversPieChart.updateData(data);

                    var currentList = listsUsageTable.getSelectedLists()[0];
                    serversDailyHeaderChart.updateData(currentList);
                    usersUsageBarChartCard.updateData(currentList);
                });

            listsUsageTable.updateData();
        });
    </script>
}
